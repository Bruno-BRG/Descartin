<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Residue Management</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Residue Management</h1>
        <label for="residueType">Residue Type:</label>
        <select id="residueType">
            <!-- Options will be populated dynamically -->
        </select>

        <label for="startDate">Start Date:</label>
        <input type="date" id="startDate">

        <label for="endDate">End Date:</label>
        <input type="date" id="endDate">

        <button onclick="generateGraph()">Generate Graph</button>

        <img id="graphImage" src="" alt="Generated Graph" style="display:none;">

        <script>
            async function fetchResidueTypes() {
                try {
                    console.log('Fetching residue types...'); // Debugging statement
                    const response = await fetch('http://127.0.0.1:5001/residue_types/');
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    const data = await response.json();
                    console.log('Fetched residue types:', data); // Debugging statement
                    const residueTypeSelect = document.getElementById('residueType');
                    data.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type;
                        option.text = type;
                        residueTypeSelect.appendChild(option);
                    });
                    console.log('Dropdown options added:', residueTypeSelect.options); // Debugging statement
                } catch (error) {
                    console.error('Failed to fetch residue types:', error);
                }
            }

            async function generateGraph() {
                const residueType = document.getElementById('residueType').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;

                try {
                    console.log('Generating graph...'); // Debugging statement
                    const response = await fetch('http://127.0.0.1:5001/generate_graph', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ residue_type: residueType, start_date: startDate, end_date: endDate })
                    });

                    if (response.ok) {
                        const blob = await response.blob();
                        const url = URL.createObjectURL(blob);
                        const img = document.getElementById('graphImage');
                        img.src = url;
                        img.style.display = 'block';
                        console.log('Graph generated successfully'); // Debugging statement
                    } else {
                        console.error('Failed to generate graph');
                    }
                } catch (error) {
                    console.error('Error generating graph:', error);
                }
            }

            // Populate residue types on page load
            document.addEventListener('DOMContentLoaded', fetchResidueTypes);
        </script>
    </div>
</body>
</html>